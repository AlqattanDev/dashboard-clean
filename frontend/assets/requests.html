<!-- Requests Page Content -->
<div x-data="requestsPage()" x-init="init()">
    <!-- Page Header -->
    <div class="mb-8">
        <h1 class="text-2xl font-bold text-gray-900">Request History</h1>
        <p class="mt-1 text-sm text-gray-600">View and manage your function execution requests.</p>
    </div>
    
    <!-- Filter and Search -->
    <div class="mb-6 bg-white p-4 rounded-lg shadow">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
                <label for="search" class="block text-sm font-medium text-gray-700 mb-1">Search</label>
                <input 
                    type="text" 
                    id="search"
                    x-model="searchTerm"
                    @input="debounceSearch()"
                    placeholder="Search requests..."
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            
            <div>
                <label for="status-filter" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                <select 
                    id="status-filter"
                    x-model="statusFilter"
                    @change="loadRequests()"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">All Status</option>
                    <option value="success">Success</option>
                    <option value="error">Error</option>
                    <option value="pending">Pending</option>
                </select>
            </div>
            
            <div>
                <label for="date-from" class="block text-sm font-medium text-gray-700 mb-1">From Date</label>
                <input 
                    type="date" 
                    id="date-from"
                    x-model="dateFrom"
                    @change="loadRequests()"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            
            <div>
                <label for="date-to" class="block text-sm font-medium text-gray-700 mb-1">To Date</label>
                <input 
                    type="date" 
                    id="date-to"
                    x-model="dateTo"
                    @change="loadRequests()"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
        </div>
        
        <div class="mt-4 flex justify-between items-center">
            <div class="text-sm text-gray-600">
                <span x-text="totalRequests"></span> total requests
            </div>
            <button 
                @click="clearFilters()"
                class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                Clear Filters
            </button>
        </div>
    </div>
    
    <!-- Requests Table -->
    <div class="bg-white shadow rounded-lg overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Function</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Duration</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200" id="requests-table-body">
                    <!-- Loading state -->
                    <tr class="animate-pulse">
                        <td class="px-6 py-4 whitespace-nowrap"><div class="h-4 bg-gray-300 rounded w-24"></div></td>
                        <td class="px-6 py-4 whitespace-nowrap"><div class="h-4 bg-gray-300 rounded w-16"></div></td>
                        <td class="px-6 py-4 whitespace-nowrap"><div class="h-4 bg-gray-300 rounded w-20"></div></td>
                        <td class="px-6 py-4 whitespace-nowrap"><div class="h-4 bg-gray-300 rounded w-16"></div></td>
                        <td class="px-6 py-4 whitespace-nowrap"><div class="h-4 bg-gray-300 rounded w-20"></div></td>
                        <td class="px-6 py-4 whitespace-nowrap"><div class="h-4 bg-gray-300 rounded w-20"></div></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Pagination -->
    <div class="mt-6 flex justify-between items-center">
        <div class="text-sm text-gray-700">
            Showing <span x-text="((currentPage - 1) * pageSize) + 1"></span> to 
            <span x-text="Math.min(currentPage * pageSize, totalRequests)"></span> of 
            <span x-text="totalRequests"></span> results
        </div>
        
        <div class="flex space-x-2">
            <button 
                @click="previousPage()"
                :disabled="currentPage <= 1"
                class="px-3 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                Previous
            </button>
            
            <!-- Page numbers -->
            <template x-for="page in pageNumbers" :key="page">
                <button 
                    @click="goToPage(page)"
                    :class="page === currentPage ? 'bg-blue-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-50'"
                    class="px-3 py-2 border border-gray-300 rounded-md text-sm font-medium">
                    <span x-text="page"></span>
                </button>
            </template>
            
            <button 
                @click="nextPage()"
                :disabled="currentPage >= totalPages"
                class="px-3 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                Next
            </button>
        </div>
    </div>
    
    <!-- Request Details Modal -->
    <div x-show="showDetailsModal" 
         x-transition:enter="ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50"
         style="display: none;">
        <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-4xl shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Request Details</h3>
                    <button @click="closeDetailsModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <div id="request-details-content" class="space-y-6">
                    <!-- Content will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<script>
window.requestsInit = function() {
    // Initialize the requests page
};

function requestsPage() {
    return {
        userRole: '',
        requests: [],
        searchTerm: '',
        statusFilter: '',
        dateFrom: '',
        dateTo: '',
        currentPage: 1,
        pageSize: 20,
        totalRequests: 0,
        totalPages: 0,
        showDetailsModal: false,
        selectedRequest: null,
        searchTimeout: null,
        
        async init() {
            await this.loadUserRole();
            await this.loadRequests();
        },
        
        async loadUserRole() {
            const token = localStorage.getItem('token');
            try {
                const response = await fetch('/api/v1/auth/me', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    const user = await response.json();
                    this.userRole = user.role;
                }
            } catch (error) {
                console.error('Error loading user role:', error);
            }
        },
        
        debounceSearch() {
            clearTimeout(this.searchTimeout);
            this.searchTimeout = setTimeout(() => {
                this.currentPage = 1; // Reset to first page when searching
                this.loadRequests();
            }, 300);
        },
        
        async loadRequests() {
            const tbody = document.getElementById('requests-table-body');
            const token = localStorage.getItem('token');
            
            const params = new URLSearchParams();
            if (this.searchTerm) params.append('search', this.searchTerm);
            if (this.statusFilter) params.append('status', this.statusFilter);
            if (this.dateFrom) params.append('date_from', this.dateFrom);
            if (this.dateTo) params.append('date_to', this.dateTo);
            params.append('page', this.currentPage);
            params.append('page_size', this.pageSize);
            
            try {
                const response = await fetch(`/api/v1/requests?${params}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    this.requests = data.items || data; // Handle both paginated and simple array responses
                    
                    // Extract pagination info if available
                    if (data.total !== undefined) {
                        this.totalRequests = data.total;
                        this.totalPages = Math.ceil(data.total / this.pageSize);
                    } else {
                        this.totalRequests = this.requests.length;
                        this.totalPages = 1;
                    }
                    
                    this.renderRequests();
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-red-600">Error loading requests</td></tr>';
                }
            } catch (error) {
                console.error('Error loading requests:', error);
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-red-600">Network error</td></tr>';
            }
        },
        
        renderRequests() {
            const tbody = document.getElementById('requests-table-body');
            
            if (this.requests.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-12">
                            <svg class="w-12 h-12 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                            </svg>
                            <h3 class="text-lg font-medium text-gray-900 mb-2">No requests found</h3>
                            <p class="text-gray-500">Try adjusting your search criteria or execute some functions.</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = this.requests.map(request => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${request.function_name || 'Unknown Function'}</div>
                        <div class="text-sm text-gray-500">${request.function_id || ''}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${this.getStatusBadgeClass(request.status)}">
                            ${request.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${request.user_id || request.username || 'Unknown'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${request.duration ? this.formatDuration(request.duration) : 'N/A'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${this.formatDate(request.created_at)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="openDetailsModal('${request.id}')" class="text-indigo-600 hover:text-indigo-900 mr-3">View</button>
                        ${request.status === 'error' ? `
                            <button onclick="retryRequest('${request.id}')" class="text-green-600 hover:text-green-900">Retry</button>
                        ` : ''}
                    </td>
                </tr>
            `).join('');
        },
        
        getStatusBadgeClass(status) {
            const classes = {
                'success': 'bg-green-100 text-green-800',
                'error': 'bg-red-100 text-red-800',
                'pending': 'bg-yellow-100 text-yellow-800',
                'running': 'bg-blue-100 text-blue-800'
            };
            return classes[status] || 'bg-gray-100 text-gray-800';
        },
        
        formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        },
        
        formatDuration(milliseconds) {
            if (milliseconds < 1000) {
                return `${milliseconds}ms`;
            }
            return `${(milliseconds / 1000).toFixed(2)}s`;
        },
        
        clearFilters() {
            this.searchTerm = '';
            this.statusFilter = '';
            this.dateFrom = '';
            this.dateTo = '';
            this.currentPage = 1;
            this.loadRequests();
        },
        
        goToPage(page) {
            this.currentPage = page;
            this.loadRequests();
        },
        
        previousPage() {
            if (this.currentPage > 1) {
                this.currentPage--;
                this.loadRequests();
            }
        },
        
        nextPage() {
            if (this.currentPage < this.totalPages) {
                this.currentPage++;
                this.loadRequests();
            }
        },
        
        get pageNumbers() {
            const pages = [];
            const start = Math.max(1, this.currentPage - 2);
            const end = Math.min(this.totalPages, this.currentPage + 2);
            
            for (let i = start; i <= end; i++) {
                pages.push(i);
            }
            
            return pages;
        },
        
        async openDetailsModal(requestId) {
            this.showDetailsModal = true;
            await this.loadRequestDetails(requestId);
        },
        
        async loadRequestDetails(requestId) {
            const container = document.getElementById('request-details-content');
            const token = localStorage.getItem('token');
            
            container.innerHTML = '<div class="text-center py-4"><div class="animate-spin inline-block w-6 h-6 border-[3px] border-current border-t-transparent rounded-full"></div></div>';
            
            try {
                const response = await fetch(`/api/v1/requests/${requestId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const request = await response.json();
                    this.selectedRequest = request;
                    this.renderRequestDetails(request);
                } else {
                    container.innerHTML = '<div class="text-center py-4 text-red-600">Error loading request details</div>';
                }
            } catch (error) {
                console.error('Error loading request details:', error);
                container.innerHTML = '<div class="text-center py-4 text-red-600">Network error</div>';
            }
        },
        
        renderRequestDetails(request) {
            const container = document.getElementById('request-details-content');
            
            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="text-sm font-medium text-gray-900 mb-2">Request Information</h4>
                        <dl class="space-y-2">
                            <div>
                                <dt class="text-xs font-medium text-gray-500">Request ID</dt>
                                <dd class="text-sm text-gray-900">${request.id}</dd>
                            </div>
                            <div>
                                <dt class="text-xs font-medium text-gray-500">Function</dt>
                                <dd class="text-sm text-gray-900">${request.function_name || 'Unknown Function'}</dd>
                            </div>
                            <div>
                                <dt class="text-xs font-medium text-gray-500">Status</dt>
                                <dd><span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${this.getStatusBadgeClass(request.status)}">${request.status}</span></dd>
                            </div>
                            <div>
                                <dt class="text-xs font-medium text-gray-500">User</dt>
                                <dd class="text-sm text-gray-900">${request.user_id || request.username || 'Unknown'}</dd>
                            </div>
                            <div>
                                <dt class="text-xs font-medium text-gray-500">Duration</dt>
                                <dd class="text-sm text-gray-900">${request.duration ? this.formatDuration(request.duration) : 'N/A'}</dd>
                            </div>
                            <div>
                                <dt class="text-xs font-medium text-gray-500">Created</dt>
                                <dd class="text-sm text-gray-900">${this.formatDate(request.created_at)}</dd>
                            </div>
                        </dl>
                    </div>
                    
                    <div>
                        <h4 class="text-sm font-medium text-gray-900 mb-2">Parameters</h4>
                        <div class="bg-gray-50 rounded-md p-3 text-xs">
                            <pre>${request.parameters ? JSON.stringify(request.parameters, null, 2) : 'No parameters'}</pre>
                        </div>
                    </div>
                </div>
                
                ${request.result ? `
                    <div>
                        <h4 class="text-sm font-medium text-gray-900 mb-2">Result</h4>
                        <div class="bg-gray-50 rounded-md p-3 text-xs">
                            <pre>${JSON.stringify(request.result, null, 2)}</pre>
                        </div>
                    </div>
                ` : ''}
                
                ${request.error ? `
                    <div>
                        <h4 class="text-sm font-medium text-red-900 mb-2">Error</h4>
                        <div class="bg-red-50 rounded-md p-3 text-xs text-red-800">
                            <pre>${request.error}</pre>
                        </div>
                    </div>
                ` : ''}
                
                ${request.logs && request.logs.length > 0 ? `
                    <div>
                        <h4 class="text-sm font-medium text-gray-900 mb-2">Logs</h4>
                        <div class="bg-gray-50 rounded-md p-3 text-xs space-y-1 max-h-64 overflow-y-auto">
                            ${request.logs.map(log => `
                                <div class="flex">
                                    <span class="text-gray-500 mr-2">[${this.formatDate(log.timestamp)}]</span>
                                    <span class="text-gray-900">${log.message}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
            `;
        },
        
        closeDetailsModal() {
            this.showDetailsModal = false;
            this.selectedRequest = null;
        },
        
        async retryRequest(requestId) {
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch(`/api/v1/requests/${requestId}/retry`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    this.showAlert('Request retry initiated successfully!', 'success');
                    await this.loadRequests();
                } else {
                    this.showAlert(result.detail || 'Failed to retry request', 'error');
                }
            } catch (error) {
                console.error('Error retrying request:', error);
                this.showAlert('Error retrying request', 'error');
            }
        },
        
        showAlert(message, type) {
            // Use the global alert function from the main app
            if (window.Alpine && Alpine.store('app')) {
                Alpine.store('app').showAlert(message, type);
            }
        }
    }
}

// Global functions for onclick handlers
window.openDetailsModal = function(requestId) {
    const requestsComponent = document.querySelector('[x-data]').__x.$data;
    if (requestsComponent && requestsComponent.openDetailsModal) {
        requestsComponent.openDetailsModal(requestId);
    }
};

window.retryRequest = function(requestId) {
    const requestsComponent = document.querySelector('[x-data]').__x.$data;
    if (requestsComponent && requestsComponent.retryRequest) {
        requestsComponent.retryRequest(requestId);
    }
};
</script>
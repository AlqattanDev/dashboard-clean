<!-- Dashboard Page Content -->
<div>
    <!-- Page Header -->
    <div class="mb-8">
        <h1 class="text-2xl font-bold text-gray-900">Dashboard</h1>
        <p class="mt-1 text-sm text-gray-600">Welcome back! Here's an overview of your operations.</p>
    </div>
    
    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8" id="stats-container">
        <!-- Loading state -->
        <div class="bg-white overflow-hidden shadow rounded-lg animate-pulse">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="h-6 w-6 bg-gray-300 rounded"></div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <div class="h-4 bg-gray-300 rounded w-3/4 mb-2"></div>
                        <div class="h-6 bg-gray-300 rounded w-1/2"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="bg-white overflow-hidden shadow rounded-lg animate-pulse">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="h-6 w-6 bg-gray-300 rounded"></div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <div class="h-4 bg-gray-300 rounded w-3/4 mb-2"></div>
                        <div class="h-6 bg-gray-300 rounded w-1/2"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="bg-white overflow-hidden shadow rounded-lg animate-pulse">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="h-6 w-6 bg-gray-300 rounded"></div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <div class="h-4 bg-gray-300 rounded w-3/4 mb-2"></div>
                        <div class="h-6 bg-gray-300 rounded w-1/2"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="bg-white overflow-hidden shadow rounded-lg animate-pulse">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="h-6 w-6 bg-gray-300 rounded"></div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <div class="h-4 bg-gray-300 rounded w-3/4 mb-2"></div>
                        <div class="h-6 bg-gray-300 rounded w-1/2"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Quick Actions -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <!-- Recent Functions -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-4 py-5 sm:p-6">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Quick Access Functions</h3>
                <div class="space-y-3" id="quick-functions">
                    <div class="text-center py-4 text-gray-500">Loading functions...</div>
                </div>
                <div class="mt-4">
                    <button onclick="Alpine.store('app').loadPage('functions')" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                        View all functions →
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Recent Activity -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-4 py-5 sm:p-6">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Recent Activity</h3>
                <div class="space-y-3" id="recent-activity">
                    <div class="text-center py-4 text-gray-500">Loading activity...</div>
                </div>
                <div class="mt-4">
                    <button onclick="Alpine.store('app').loadPage('requests')" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                        View all activity →
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
window.dashboardInit = function() {
    loadDashboardStats();
    loadQuickFunctions();
    loadRecentActivity();
};

async function loadDashboardStats() {
    const container = document.getElementById('stats-container');
    const token = localStorage.getItem('token');
    
    try {
        const response = await fetch('/api/dashboard/stats', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (response.ok) {
            const stats = await response.json();
            container.innerHTML = `
                <!-- Total Functions -->
                <div class="bg-white overflow-hidden shadow rounded-lg">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                                </svg>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-gray-500 truncate">Available Functions</dt>
                                    <dd class="text-lg font-medium text-gray-900">${stats.totalFunctions || 0}</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pending Requests -->
                <div class="bg-white overflow-hidden shadow rounded-lg">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <svg class="h-6 w-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-gray-500 truncate">Pending Requests</dt>
                                    <dd class="text-lg font-medium text-gray-900">${stats.pendingRequests || 0}</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Today's Executions -->
                <div class="bg-white overflow-hidden shadow rounded-lg">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 003.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"></path>
                                </svg>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-gray-500 truncate">Today's Executions</dt>
                                    <dd class="text-lg font-medium text-gray-900">${stats.todayExecutions || 0}</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- User Role -->
                <div class="bg-white overflow-hidden shadow rounded-lg">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <svg class="h-6 w-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-gray-500 truncate">Your Role</dt>
                                    <dd class="text-lg font-medium text-gray-900 capitalize">${stats.userRole || 'Member'}</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading stats:', error);
    }
}

async function loadQuickFunctions() {
    const container = document.getElementById('quick-functions');
    const token = localStorage.getItem('token');
    
    try {
        const response = await fetch('/api/dashboard/functions', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (response.ok) {
            const functions = await response.json();
            if (functions.length > 0) {
                container.innerHTML = functions.map(func => `
                    <div class="flex items-center justify-between p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                        <div class="flex-1">
                            <div class="flex items-center space-x-3">
                                <div class="flex-shrink-0">
                                    <span class="w-2 h-2 rounded-full ${getMethodColor(func.http_method)}"></span>
                                </div>
                                <div>
                                    <p class="font-medium text-gray-900">${func.name}</p>
                                    <p class="text-sm text-gray-500">${func.http_method} • ${func.min_role}+</p>
                                </div>
                            </div>
                        </div>
                        <div class="flex-shrink-0 ml-4">
                            <button 
                                onclick="executeFunction('${func.id}')"
                                class="text-blue-600 hover:text-blue-800 text-sm font-medium transition-colors">
                                Execute
                            </button>
                        </div>
                    </div>
                `).join('');
            } else {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <svg class="w-12 h-12 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                        </svg>
                        <p class="text-sm">No functions available</p>
                        <p class="text-xs text-gray-400 mt-1">Contact your administrator to add functions</p>
                    </div>
                `;
            }
        }
    } catch (error) {
        console.error('Error loading functions:', error);
    }
}

async function loadRecentActivity() {
    const container = document.getElementById('recent-activity');
    const token = localStorage.getItem('token');
    
    try {
        const response = await fetch('/api/dashboard/activity', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (response.ok) {
            const activity = await response.json();
            if (activity.length > 0) {
                container.innerHTML = activity.map(item => `
                    <div class="flex items-center space-x-3 p-3 border border-gray-200 rounded-lg">
                        <div class="flex-shrink-0">
                            <span class="status-badge ${getStatusClass(item.status)}">${item.status}</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-900 truncate">${item.function_name}</p>
                            <p class="text-sm text-gray-500">${formatDate(item.created_at)}</p>
                        </div>
                    </div>
                `).join('');
            } else {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <p class="text-sm">No recent activity</p>
                    </div>
                `;
            }
        }
    } catch (error) {
        console.error('Error loading activity:', error);
    }
}

function getMethodColor(method) {
    const colors = {
        'GET': 'bg-green-400',
        'POST': 'bg-blue-400',
        'PUT': 'bg-yellow-400',
        'DELETE': 'bg-red-400'
    };
    return colors[method] || 'bg-gray-400';
}

function getStatusClass(status) {
    const classes = {
        'success': 'status-success',
        'error': 'status-error',
        'pending': 'status-pending'
    };
    return classes[status] || 'status-warning';
}

function formatDate(dateString) {
    return new Date(dateString).toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function executeFunction(functionId) {
    // Navigate to functions page and execute
    Alpine.store('app').loadPage('functions').then(() => {
        // Trigger function execution after page loads
        setTimeout(() => {
            if (window.openExecuteModal) {
                window.openExecuteModal(functionId);
            }
        }, 100);
    });
}
</script>